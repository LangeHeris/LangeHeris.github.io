<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>内网穿透——NPS | Soul Stream</title><meta name="author" content="Lange Heris"><meta name="copyright" content="Lange Heris"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0000FF"><meta name="description" content="前言——关于内网穿透什么是内网穿透？百度百科：  内网穿透，即NAT穿透，网络连接时术语，计算机是局域网内时，外网与内网的计算机节点需要连接通信，有时就会出现不支持内网穿透。就是说映射端口，能让外网的电脑找到处于内网的电脑，提高下载速度。不管是内网穿透还是其他类型的网络穿透，都是网络穿透的统一方法来研究和解决。  人话：就是将内网(LAN)IP转换成可以在公网(WAN)使用的公网IP。让互联网上的">
<meta property="og:type" content="article">
<meta property="og:title" content="内网穿透——NPS">
<meta property="og:url" content="http://langeheris.github.io/2020/03/28/Intranet-penetration/index.html">
<meta property="og:site_name" content="Soul Stream">
<meta property="og:description" content="前言——关于内网穿透什么是内网穿透？百度百科：  内网穿透，即NAT穿透，网络连接时术语，计算机是局域网内时，外网与内网的计算机节点需要连接通信，有时就会出现不支持内网穿透。就是说映射端口，能让外网的电脑找到处于内网的电脑，提高下载速度。不管是内网穿透还是其他类型的网络穿透，都是网络穿透的统一方法来研究和解决。  人话：就是将内网(LAN)IP转换成可以在公网(WAN)使用的公网IP。让互联网上的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-801f11f4b2bf9a7061965ac94bc8c9bb_720w.jpeg">
<meta property="article:published_time" content="2020-03-27T16:00:00.000Z">
<meta property="article:modified_time" content="2023-08-01T06:10:18.806Z">
<meta property="article:author" content="Lange Heris">
<meta property="article:tag" content="教程">
<meta property="article:tag" content="内网穿透">
<meta property="article:tag" content="NAT">
<meta property="article:tag" content="NPS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic1.zhimg.com/80/v2-801f11f4b2bf9a7061965ac94bc8c9bb_720w.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://langeheris.github.io/2020/03/28/Intranet-penetration/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//static.cloudflareinsights.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?009444a024f29811d7378276af465b8e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-160039268-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-160039268-1');
</script><script defer="defer" data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;48cb7d4116284c0097302a60452624c6&quot;}"></script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "cfy7z48ccb");</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"78LXNWIQ9Q","apiKey":"7013fe0b26507ea2b3d9028aac6dfad6","indexName":"soulstream","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网穿透——NPS',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-01 14:10:18'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0000FF')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0000FF')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><style type="text/css">.framework-info{visibility:hidden;}</style><meta name="generator" content="Hexo 5.4.2"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="/css/minimal.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/logs/"><i class="fa-fw fas fa-commenting"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 章略</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-user-circle"></i><span> 关隅</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 图册</span></a></li><li><a class="site-page child" href="/steamgames/"><i class="fa-fw fab fa-steam"></i><span> 游戏</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic4.zhimg.com/80/v2-21523755f9b6229453735a5aab21d370_720w.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="Soul Stream"><img class="site-icon" src="/img/favicon.png"/><span class="site-name">Soul Stream</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/logs/"><i class="fa-fw fas fa-commenting"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 章略</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 总览</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-user-circle"></i><span> 关隅</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-image"></i><span> 图册</span></a></li><li><a class="site-page child" href="/steamgames/"><i class="fa-fw fab fa-steam"></i><span> 游戏</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内网穿透——NPS</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-27T16:00:00.000Z" title="发表于 2020-03-28 00:00:00">2020-03-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-01T06:10:18.806Z" title="更新于 2023-08-01 14:10:18">2023-08-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%99%E7%A8%8B/">教程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内网穿透——NPS"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2020/03/28/Intranet-penetration/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2020/03/28/Intranet-penetration/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言——关于内网穿透"><a href="#前言——关于内网穿透" class="headerlink" title="前言——关于内网穿透"></a>前言——关于内网穿透</h1><h2 id="什么是内网穿透？"><a href="#什么是内网穿透？" class="headerlink" title="什么是内网穿透？"></a>什么是内网穿透？</h2><p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/8597835?fr=aladdin">百度百科</a>：</p>
<blockquote>
<p>内网穿透，即NAT穿透，网络连接时术语，计算机是局域网内时，外网与内网的计算机节点需要连接通信，有时就会出现不支持内网穿透。就是说映射端口，能让外网的电脑找到处于内网的电脑，提高下载速度。不管是内网穿透还是其他类型的网络穿透，都是网络穿透的统一方法来研究和解决。</p>
</blockquote>
<p>人话：就是将内网(LAN)IP转换成可以在公网(WAN)使用的公网IP。让互联网上的用户可以通过此公网IP地址访问特定的内网主机所提供的网站或者服务器。而内网主机可以是你的PC，也可以是云服务器，甚至可以是你的树莓派。</p>
<h2 id="内网穿透可以干什么？"><a href="#内网穿透可以干什么？" class="headerlink" title="内网穿透可以干什么？"></a>内网穿透可以干什么？</h2><p>说白了就是内网穿透可以通过外网直接访问到你家的电脑。</p>
<p>具体一点的：</p>
<ul>
<li>发布应用/网站,外网可以访问。</li>
<li>可以实现远程控制,随时随地都能用家里的电脑。</li>
<li>自建游戏服务。</li>
<li>搭设个人网络存储服务器。</li>
</ul>
<hr>
<h1 id="解决方案——NPS"><a href="#解决方案——NPS" class="headerlink" title="解决方案——NPS"></a>解决方案——NPS</h1><table>
<thead>
<tr>
<th>名称</th>
<th align="left">API</th>
<th align="left">客户端单独KEY</th>
<th align="left">子域名支持</th>
<th align="left">收费模式</th>
<th align="left">语言</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/inconshreveable/ngrok">ngrok</a></td>
<td align="left">支持</td>
<td align="left">未知</td>
<td align="left">支持（但收费）</td>
<td align="left">按客户端数量收费</td>
<td align="left">GO</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a></td>
<td align="left">不支持</td>
<td align="left">统一</td>
<td align="left">支持（但收费）</td>
<td align="left">按客户端数量收费</td>
<td align="left">GO</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/ffay/lanproxy">lanproxyp</a></td>
<td align="left">不支持</td>
<td align="left">单独</td>
<td align="left">未知</td>
<td align="left">免费</td>
<td align="left">java</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/snail007/goproxy">goproxy</a></td>
<td align="left">支持</td>
<td align="left">未知</td>
<td align="left">未知</td>
<td align="left">API版收费</td>
<td align="left">Go</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/cnlh/nps">nps</a></td>
<td align="left">支持</td>
<td align="left">单独</td>
<td align="left">支持</td>
<td align="left">免费</td>
<td align="left">Go</td>
</tr>
</tbody></table>
<p>上面列举了几个比较主流的内网穿透工具，此外国内还有比较“知名”的花生壳（百家号警告.jpg）。</p>
<h2 id="NPS"><a href="#NPS" class="headerlink" title="NPS"></a>NPS</h2><p>nps原名easyProxy，是一款轻量级、高性能、功能强大的内网穿透代理服务器。目前支持tcp、udp流量转发，可支持任何tcp、udp上层协议（访问内网网站、本地支付接口调试、ssh访问、远程桌面，内网dns解析等等……），此外还支持内网http代理、内网socks5代理、p2p等，并带有功能强大的web管理端。</p>
<h2 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h2><ul>
<li>协议支持全面，兼容几乎所有常用协议，例如tcp、udp、http(s)、socks5、p2p、http代理…</li>
<li>全平台兼容(linux、windows、macos、群辉等)，支持一键安装为系统服务</li>
<li>控制全面，同时支持服务端和客户端控制</li>
<li>https集成，支持将后端代理和web服务转成https，同时支持多证书</li>
<li>操作简单，只需简单的配置即可在web ui上完成其余操作</li>
<li>展示信息全面，流量、系统信息、即时带宽、客户端版本等</li>
<li>扩展功能强大，该有的都有了（缓存、压缩、加密、流量限制、带宽限制、端口复用等等）</li>
<li>域名解析具备自定义header、404页面配置、host修改、站点保护、URL路由、泛解析等功能</li>
<li>服务端支持多用户和用户注册功能</li>
</ul>
<p>详情请看开发者文档：<a target="_blank" rel="noopener" href="https://github.com/ehang-io/nps/blob/master/README_zh.md">中文文档</a></p>
<p><strong>具体安装方法文档也有说，我只讲我的安装流程。</strong></p>
<h1 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h1><p>一般内网穿透工具都有服务端和客户端，安装要求如下：</p>
<blockquote>
<p>服务端：需要安装在一个有公网IP的服务器上，系统为Linux/Windows/Mac均可。<br>客户端：一般安装在一个内网的VPS服务器或Windows/Mac电脑上使用。</p>
</blockquote>
<p>服务端安装需要我们有一台拥有静态公网IP的服务器，国内各大云主机服务商均有销售。</p>
<p>（阿里云、腾讯云、华为云、天翼云、百度云、新浪云、京东云、美团云、七牛云…….）</p>
<h2 id="服务器选购方面："><a href="#服务器选购方面：" class="headerlink" title="服务器选购方面："></a>服务器选购方面：</h2><p>操作系统就两个方案，linux和windows sever</p>
<p>windows sever我就不多说了，有点追求的都用linux 推荐centos6/7</p>
<p>用作内网穿透的话对CPU性能、内存、以及硬盘容量都没有要求，选择最便宜的即可。</p>
<p>网络带宽最重要，一般服务器就贵在带宽。 </p>
<p>网络带宽参考：</p>
<table>
<thead>
<tr>
<th>应用方面</th>
<th>协议</th>
<th>推荐服务器带宽</th>
<th>网络延迟（本地ping服务器）</th>
</tr>
</thead>
<tbody><tr>
<td>远程桌面</td>
<td>tcp/udp隧道</td>
<td>&gt;5mbps</td>
<td>&lt;50ms</td>
</tr>
<tr>
<td>游戏开服</td>
<td>tcp/udp隧道</td>
<td>无要求</td>
<td>&lt;80ms</td>
</tr>
<tr>
<td>个人云端</td>
<td>p2p连接</td>
<td>&gt;10mbps</td>
<td>&lt;30ms</td>
</tr>
<tr>
<td>网站调试</td>
<td>http/https</td>
<td>无要求</td>
<td>无要求</td>
</tr>
</tbody></table>
<p>注：网络带宽速度取决于使用场景</p>
<p>服务器买完后，请从供应商处获取相应的登录信息。</p>
<p>Windows Sever建议直接远程桌面。<br>Linux有puTTY、SecureCRT、XShell等多种选择。</p>
<h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><p>ssh链接成功后，开始配置服务端</p>
<p>首先请确保防火墙开放了所有端口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -L -n</span><br></pre></td></tr></table></figure>

<p>出现以下结果，代表端口全部开放。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt source               destination</span><br></pre></td></tr></table></figure>
<p>否则可以使用以下命令关闭防火墙</p>
<p>CentOS6:：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop iptables</span><br><span class="line">systemctl disable iptables</span><br></pre></td></tr></table></figure>
<p>CentOS7:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<p>如果你使用的是其他Linux发行版，以上命令无效，请自行搜索Linux如何关闭防火墙。</p>
<p><font color="red">注:文章中出现的所有端口都要放行.</font><br>(阿里云要在服务器控制台的安全组中设置.)</p>
<p><strong>完成以上步骤后去Github下载作者编译好的压缩包。</strong><br>下载地址：<a target="_blank" rel="noopener" href="https://github.com/ehang-io/nps/releases">https://github.com/ehang-io/nps/releases</a><br>请选择和服务器对应的版本，比如我的服务器用的CentOS7 64位，选择的是linux_amd64_server.tar.gz</p>
<p>右键要下载的版本，点复制下载链接，然后在linux里输入以下指令( wget+[下载链接] )</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://github.com/ehang-io/nps/releases/download/v0.26.6/linux_amd64_server.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下载完后，输入<code>ls</code>查看目录下是否有 <font color="red">linux_amd64_server.tar.gz</font>压缩包</p>
<p>注：linux下的压缩包显示为红色、可执行文件为绿色文件、目录为蓝色。</p>
<p>最近github抽风，下载速度几kb是正常的。</p>
<p>确认无误后，输入以下指令解压压缩包。（PS：这里我忘记解压到文件夹里了，将就吧。）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -zxf linux_amd64_server.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>解压完成后输入<code>ls</code>确认多出来的文件。</p>
<p>具体文件大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">conf  linux_amd64_server.tar.gz nps  web</span><br></pre></td></tr></table></figure>
<p>注：想删掉压缩包就输入<code>rm linux_amd64_server.tar.gz</code></p>
<p>然后输入以下指令进入conf文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd conf</span><br></pre></td></tr></table></figure>
<p>并用vim编辑配置文件件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi nps.conf</span><br></pre></td></tr></table></figure>
<p>按<code>i</code>键开始编辑，编辑完后按esc键，然后输入<code>:wq</code>保存退出。</p>
<p>以下是配置文件是精简后的，按需修改。（ []内输入你要的内容。 ）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">appname = nps</span><br><span class="line">#Boot mode(dev|pro)</span><br><span class="line">runmode = dev</span><br><span class="line"></span><br><span class="line">##bridge</span><br><span class="line"># 底层通信协议，默认tcp，可选用kcp</span><br><span class="line">bridge_type=tcp</span><br><span class="line"># 底层通信端口，默认8024，如已被占用请指定其他端口</span><br><span class="line">bridge_port=8024</span><br><span class="line">bridge_ip=0.0.0.0</span><br><span class="line"></span><br><span class="line"># 当客户端以配置文件模式启动时会用到的验证密钥，可自行设置。不设置他会自动生成</span><br><span class="line">public_vkey=[你的通信密钥]</span><br><span class="line"></span><br><span class="line">#web</span><br><span class="line">web_host=[这里输入你的服务器IP或域名]</span><br><span class="line">web_username=[设置用户名]</span><br><span class="line">web_password=[设置密码]</span><br><span class="line">web_port = [网页面板的端口]</span><br><span class="line">web_ip=0.0.0.0</span><br></pre></td></tr></table></figure>

<p><strong>服务端配置文件含义：</strong></p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>web_port</td>
<td>web管理端口</td>
</tr>
<tr>
<td>web_password</td>
<td>web界面管理密码</td>
</tr>
<tr>
<td>web_username</td>
<td>web界面管理账号</td>
</tr>
<tr>
<td>web_base_url</td>
<td>web管理主路径,用于将web管理置于代理子路径后面</td>
</tr>
<tr>
<td>bridge_port</td>
<td>服务端客户端通信端口</td>
</tr>
<tr>
<td>https_proxy_port</td>
<td>域名代理https代理监听端口</td>
</tr>
<tr>
<td>http_proxy_port</td>
<td>域名代理http代理监听端口</td>
</tr>
<tr>
<td>auth_key</td>
<td>web api密钥</td>
</tr>
<tr>
<td>bridge_type</td>
<td>客户端与服务端连接方式kcp或tcp</td>
</tr>
<tr>
<td>public_vkey</td>
<td>客户端以配置文件模式启动时的密钥，设置为空表示关闭客户端配置文件连接模式</td>
</tr>
<tr>
<td>ip_limit</td>
<td>是否限制ip访问，true或false或忽略</td>
</tr>
<tr>
<td>flow_store_interval</td>
<td>服务端流量数据持久化间隔，单位分钟，忽略表示不持久化</td>
</tr>
<tr>
<td>log_level</td>
<td>日志输出级别</td>
</tr>
<tr>
<td>auth_crypt_key</td>
<td>获取服务端authKey时的aes加密密钥，16位</td>
</tr>
<tr>
<td>p2p_ip</td>
<td>服务端Ip，使用p2p模式必填</td>
</tr>
<tr>
<td>p2p_port</td>
<td>p2p模式开启的udp端口</td>
</tr>
<tr>
<td>pprof_ip</td>
<td>debug pprof 服务端ip</td>
</tr>
<tr>
<td>pprof_port</td>
<td>debug pprof 端口</td>
</tr>
</tbody></table>
<p>详细的配置参数，请参考<a target="_blank" rel="noopener" href="https://ehang-io.github.io/nps/#/nps_extend">开发者的网站</a></p>
<p>调完配置参数后，请使用以下命令启动nps服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./nps start  /* 后台启动服务 */</span><br><span class="line">./nps stop  /* 结束后台进程 */</span><br><span class="line">./nps reload  /* 重新加载配置 */</span><br><span class="line">./nps  /* 前台启动服务 */</span><br></pre></td></tr></table></figure>
<p>注：如果输入<code>./nps start</code>无效，请输入<code>./nps</code>启动。</p>
<p>启动后，可以去浏览器访问网页管理面板（在浏览器中输入”[你服务器的IP或域名]:[网页面板端口]”）</p>
<p>如果能打开网页并成功登陆，则说明服务端配置完成。</p>
<p><img src="https://s2.loli.net/2023/08/01/2gTZKYFSLWC69mp.png" alt="登陆界面"><br>输入设置好的账号密码登陆页面。<br><img src="https://s2.loli.net/2023/08/01/t3uYosCcGMTVXF5.png" alt="管理面板"></p>
<p><strong>如果打不开页面，并报错以下内容。</strong></p>
<p><code>[E] [http.go:67]  listen tcp 0.0.0.0:80: bind: address already in use</code></p>
<p>说明你的端口被占用了，解决办法：</p>
<p>输入<code>netstat -nap</code>查看占用端口的程序PID，输入<code>kill PID</code>,干掉那个在运行的程序。（你也可以选择改端口）<br><img src="https://s2.loli.net/2023/08/01/EODbAiJHpQfkqXK.jpg"><br>然后再启动nps</p>
<h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><p>在<strong>内网设备</strong>中下载对应的nps客户端<a target="_blank" rel="noopener" href="https://github.com/ehang-io/nps/releases">下载地址</a><br>比如,我用的是windows 64位，所以选择的是windows_amd64_client.tar.gz（32位系统请下载386版本）</p>
<p>下载完成后，放在合适的目录并解压缩。</p>
<p>与其他老牌内网穿透工具不同，nps能在网页完成对客户端的管理和配置，极其方便。（如果你想，也可以在客户端完成所有配置而不去理会网页管理面板）</p>
<hr>
<p>进入网页管理面板：<br><img src="https://s2.loli.net/2023/08/01/UoPGkyCra2FlRS1.png"></p>
<h3 id="第一步-新增客户端"><a href="#第一步-新增客户端" class="headerlink" title="第一步 新增客户端"></a>第一步 新增客户端</h3><p>备注随便填 唯一验证密匙可以不用管  允许客户端通过配置文件链接 开压缩和加密<br><img src="https://s2.loli.net/2023/08/01/wL6PbIacfRBt9Fg.png"></p>
<p><strong>允许客户端通过配置文件链接可能会造成配置文件冲突</strong>  <font color="blue">后面附带解决方案。</font></p>
<p>添加完成后，可以在列表中看到客户端信息，且客户端处于离线状态。</p>
<p><strong>如果添加不了，并且浏览器出现undefined的提示框</strong>说明你用的浏览器太垃圾了，让你换谷歌浏览器。</p>
<h3 id="第二步-复制客户端指令"><a href="#第二步-复制客户端指令" class="headerlink" title="第二步 复制客户端指令"></a>第二步 复制客户端指令</h3><p>点击左侧+号按钮查看详细信息，我们可以看到系统生成（或手动指定）的<strong>验证密钥</strong>，以及客户端连接服务端的<strong>客户端命令</strong>。<br><img src="https://s2.loli.net/2023/08/01/RPqWheFdJmCpXy7.png"></p>
<p>我们需要复制那个红色代码块。</p>
<p><code>./npc -server=公网IP地址:端口 -vkey=你的通信密钥 -type=tcp</code></p>
<h3 id="第三步-启动客户端-amp-RDP协议"><a href="#第三步-启动客户端-amp-RDP协议" class="headerlink" title="第三步 启动客户端&amp;RDP协议"></a>第三步 启动客户端&amp;RDP协议</h3><p><strong>这里我忘记说了，windows电脑需要 专业版，并且开启远程桌面。</strong></p>
<p>步骤1：设置——系统——远程左面<br>步骤2：控制面板——系统和安全——系统——远程设置&gt;选允许远程设置——高级&gt;允许被控制 </p>
<p>完成以上步骤确定保存。</p>
<p>非专业版windows要打补丁。</p>
<p>下载<a target="_blank" rel="noopener" href="https://github.com/stascorp/rdpwrap/releases">RDP Wrapper Library</a></p>
<p>推荐下载 RDPWrap-v1.6.2.zip</p>
<p>解压后以<strong>管理员的身份</strong>运行install.bat</p>
<p>然后运行RDPConf.exe dignostics全绿表示正常<br><img src="https://s2.loli.net/2023/08/01/CRAPQMemNtk9lBV.png"></p>
<p><strong>如果出现红字，请更新rdpwrap.ini文件</strong><br>Github大佬做的自动更新文件：<a target="_blank" rel="noopener" href="https://github.com/asmtron/rdpwrap/blob/master/res/rdpwrap.ini">目前最新版本</a></p>
<p>复制全部内容编辑添加到rdpwrap.ini里，再次运行RDPConf.exe便会出现全绿。<br><strong>rdpwrap.ini，在C:\PROGRAM FILES\RDP WAPPER文件夹里。</strong></p>
<p><strong>注意：RDP需要重启电脑才能生效</strong></p>
<p>复制红色代码块后，启动windows的CMD </p>
<p>移动到到存放nps客户端的目录</p>
<p><strong>注：Windows下使用的命令与管理面板中复制的有所不同，请把”./npc”部分替换为”npc”。</strong></p>
<p><code>npc.exe -server=公网IP地址:端口 -vkey=你的通信密钥 -type=tcp</code></p>
<p><strong>如果你用的git bash,可以之间去nps客户端目录右键git bash且客户端代码不需要改动。</strong></p>
<p>如果没有报错，可以访问网页管理面板查看客户端是否变为在线状态。</p>
<p>如果是在线状态，则代表内网穿透成功。 </p>
<p><font color="red">注：命令窗口不能关闭，要一直开着，关闭会变成离线。</font></p>
<hr>
<h3 id="客户端通过配置文件链接-报错解决方案-amp-配置nps客户端npc-conf文件"><a href="#客户端通过配置文件链接-报错解决方案-amp-配置nps客户端npc-conf文件" class="headerlink" title="客户端通过配置文件链接_报错解决方案 &amp; 配置nps客户端npc.conf文件"></a>客户端通过配置文件链接_报错解决方案 &amp; 配置nps客户端npc.conf文件</h3><p><strong>配置npc.conf文件可以解决每次启动都需要客户端代码的问题。</strong></p>
<p>进入客户端目录，打开conf文件夹，编辑npc.conf文件，具体如图。<br><img src="https://s2.loli.net/2023/08/01/kfSbaLN4FVBPwhd.png"><br>删掉<strong>多余的配置参数</strong>，保留需要的参数，比如：common</p>
<p>否则启动npc.exe的时候会报错。</p>
<h4 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h4><h5 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>server_addr</td>
<td>服务端ip:port</td>
</tr>
<tr>
<td>conn_type</td>
<td>与服务端通信模式(tcp或kcp)</td>
</tr>
<tr>
<td>vkey</td>
<td>服务端配置文件中的密钥(非web)</td>
</tr>
<tr>
<td>username</td>
<td>socks5或http(s)密码保护用户名(可忽略)</td>
</tr>
<tr>
<td>password</td>
<td>socks5或http(s)密码保护密码(可忽略)</td>
</tr>
<tr>
<td>compress</td>
<td>是否压缩传输(true或false或忽略)</td>
</tr>
<tr>
<td>crypt</td>
<td>是否加密传输(true或false或忽略)</td>
</tr>
<tr>
<td>rate_limit</td>
<td>速度限制，可忽略</td>
</tr>
<tr>
<td>flow_limit</td>
<td>流量限制，可忽略</td>
</tr>
<tr>
<td>remark</td>
<td>客户端备注，可忽略</td>
</tr>
<tr>
<td>max_conn</td>
<td>最大连接数，可忽略</td>
</tr>
<tr>
<td>pprof_addr</td>
<td>debug pprof ip:port</td>
</tr>
</tbody></table>
<h5 id="域名代理"><a href="#域名代理" class="headerlink" title="域名代理"></a>域名代理</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>web1</td>
<td>备注</td>
</tr>
<tr>
<td>host</td>
<td>域名(http</td>
</tr>
<tr>
<td>target_addr</td>
<td>内网目标，负载均衡时多个目标，逗号隔开</td>
</tr>
<tr>
<td>host_change</td>
<td>请求host修改</td>
</tr>
<tr>
<td>header_xxx</td>
<td>请求header修改或添加，header_proxy表示添加header proxy:nps</td>
</tr>
</tbody></table>
<h5 id="tcp隧道模式"><a href="#tcp隧道模式" class="headerlink" title="tcp隧道模式"></a>tcp隧道模式</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mode</td>
<td>tcp</td>
</tr>
<tr>
<td>server_port</td>
<td>在服务端的代理端口</td>
</tr>
<tr>
<td>tartget_addr</td>
<td>内网目标</td>
</tr>
</tbody></table>
<h5 id="http代理模式"><a href="#http代理模式" class="headerlink" title="http代理模式"></a>http代理模式</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mode</td>
<td>httpProxy</td>
</tr>
<tr>
<td>server_port</td>
<td>在服务端的代理端口</td>
</tr>
</tbody></table>
<h5 id="socks5代理模式"><a href="#socks5代理模式" class="headerlink" title="socks5代理模式"></a>socks5代理模式</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mode</td>
<td>socks5</td>
</tr>
<tr>
<td>server_port</td>
<td>在服务端的代理端口</td>
</tr>
<tr>
<td>multi_account</td>
<td>socks5多账号配置文件（可选),配置后使用basic_username和basic_password无法通过认证</td>
</tr>
</tbody></table>
<h5 id="私密代理模式"><a href="#私密代理模式" class="headerlink" title="私密代理模式"></a>私密代理模式</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mode</td>
<td>secret</td>
</tr>
<tr>
<td>password</td>
<td>唯一密钥</td>
</tr>
<tr>
<td>target_addr</td>
<td>内网目标</td>
</tr>
</tbody></table>
<h5 id="p2p代理模式"><a href="#p2p代理模式" class="headerlink" title="p2p代理模式"></a>p2p代理模式</h5><table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mode</td>
<td>p2p</td>
</tr>
<tr>
<td>password</td>
<td>唯一密钥</td>
</tr>
<tr>
<td>target_addr</td>
<td>内网目标</td>
</tr>
</tbody></table>
<h5 id="文件访问模式"><a href="#文件访问模式" class="headerlink" title="文件访问模式"></a>文件访问模式</h5><p>利用nps提供一个公网可访问的本地文件服务，此模式仅客户端使用配置文件模式方可启动</p>
<table>
<thead>
<tr>
<th>项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>mode</td>
<td>file</td>
</tr>
<tr>
<td>server_port</td>
<td>服务端开启的端口</td>
</tr>
<tr>
<td>local_path</td>
<td>本地文件目录</td>
</tr>
<tr>
<td>strip_pre</td>
<td>前缀</td>
</tr>
</tbody></table>
<p>对于<code>strip_pre</code>，访问公网<code>ip:9100/web/</code>相当于访问<code>/tmp/</code>目录</p>
<h1 id="NPS玩法"><a href="#NPS玩法" class="headerlink" title="NPS玩法"></a>NPS玩法</h1><h2 id="TCP-UDP隧道"><a href="#TCP-UDP隧道" class="headerlink" title="TCP/UDP隧道"></a>TCP/UDP隧道</h2><p>使用场景：Windows远程桌面，ssh连接，vnc连接，游戏开服，内网架设dns服务器等</p>
<h3 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h3><p>以Windows远程桌面为例，其默认使用3389端口。</p>
<p>假设局域网内有一台IP为192.168.1.100的Windows设备，那么，在同一局域网下，只要访问192.168.1.100:3389即可连接。</p>
<p>但如果想要从外网连接，则必须添加一条TCP转发规则，把内网设备的3389端口，映射到服务端的某个端口，这里假设使用服务器的10000端口。</p>
<p>假如<strong>服务器IP</strong>为12.34.56.78，那么，映射完成后，外网访问12.34.56.78:10000的请求会全部被转发到192.168.1.100:3389。</p>
<p>也就是说，访问12.34.56.78:10000即可连接内网的windows设备。具体配置如下。</p>
<p><img src="https://s2.loli.net/2023/08/01/aF8lO3fVsWShiuA.png"></p>
<p>服务端端口 范围是从0 到65535的整数数字，这个范围内随便选一个没有被占用的端口。</p>
<p>推荐是10000 ~ 65000这个范围内选一个。</p>
<p>目标 (IP:端口) 填 127.0.0.1:3389</p>
<p>127.0.0.1是内网的地址，端口3389是windows远程桌面的默认端口。</p>
<p>点击新增完成配置。</p>
<p>完成后，可以在手机上安装微软的手机端远程桌面控制—— RD Client</p>
<p>尝试通过 <code>你的公网服务器IP:你选的服务端端口</code> 连接内网windows设备，如可以成功连接，则内网穿透成功。</p>
<h2 id="P2P连接"><a href="#P2P连接" class="headerlink" title="P2P连接"></a>P2P连接</h2><p>使用场景:大文件传输，如在内网架设NAS，流量不经过服务器转发。</p>
<p>目标内网设备与访问端都需要运行npc，且二者NAT类型不能同时为对称型网络</p>
<p>配置方法与TCP/UDP的配置方法大同小异，只需要修改配置文件即可，不做演示。</p>
<h1 id="疑难解答"><a href="#疑难解答" class="headerlink" title="疑难解答"></a>疑难解答</h1><h2 id="为什么-断开Linux远程终端关闭后，NPS后台的进程也结束了？"><a href="#为什么-断开Linux远程终端关闭后，NPS后台的进程也结束了？" class="headerlink" title="为什么 断开Linux远程终端关闭后，NPS后台的进程也结束了？"></a>为什么 断开Linux远程终端关闭后，NPS后台的进程也结束了？</h2><p>Windows远程桌面连接后，运行某个程序，可以退出连接并且不会随着中止连接而结束。</p>
<p>Linux在终端登陆远程主机并运行程序后，如果此时直接中止连接退出，那么这个连接所开的会话（session）下运行的所有进程都会随着中止连接而结束。</p>
<p>这是windows与Linux的不同。</p>
<h3 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h3><h4 id="1）进程的相关概念："><a href="#1）进程的相关概念：" class="headerlink" title="1）进程的相关概念："></a>1）进程的相关概念：</h4><p>在Linux中，每个进程都属于一个进程组（group），每个进程组有一个组长。</p>
<p>多个进程组构成一个会话，会话是由其中的进程建立的，该进程叫做会话的领导进程(session leader)。</p>
<p>会话领导进程的PID成为识别会话的SID(session ID)。</p>
<p>会话中的每个进程组称为一个工作(job)。</p>
<p>会话可以有一个进程组成为会话的前台工作(foreground job)，而其他的进程组是后台工作(background job)。</p>
<p>并不是进程组中的每个进程都是job中的内容，job是由session进程直接的“儿子”组成的，但是当job中的进程又产生子进程的时候，子进程便不是job中的内容。</p>
<p>每个会话可以连接一个控制终端(control terminal)。当控制终端有输入输出时，都传递给该会话的前台进程组。当前台进程组或者说job中的最后一个进程结束后，后台的session控制进程自动切换至前端，由终端产生的信号，比如CTRL+Z， CTRL+\，会传递到前台进程组。</p>
<p>会话主要是针对一个终端建立，当我们打开多个终端窗口时，实际上就创建了多个终端会话。每个会话都会有自己的前台工作和后台工作。这样，我们就为进程增加了管理和运行的层次。</p>
<h4 id="2）终端的相关概念"><a href="#2）终端的相关概念" class="headerlink" title="2）终端的相关概念"></a>2）终端的相关概念</h4><p>在UNIX系统中，用户通过终端登录系统后得到一个Shell进程，这个终端成为Shell进程的控制终端（Controlling Terminal），控制终端是保存在PCB中的信息，而我们知道fork会复制PCB中的信息，因此由Shell进程启动的其它进程的控制终端也是这个终端。</p>
<p>默认情况下（没有重定向），每个进程的标准输入、标准输出和标准错误输出都指向控制终端，进程从标准输入读也就是读用户的键盘输入，进程往标准输出或标准错误输出写也就是输出到显示器上。在控制终端输入一些特殊的控制键可以给前台进程发信号，例如Ctrl-C表示SIGINT，Ctrl-表示SIGQUIT。</p>
<p>每个进程都可以通过一个特殊的设备文件/dev/tty访问它的控制终端。事实上每个终端设备都对应一个不同的设备文件，/dev/tty提供了一个通用的接口，一个进程要访问它的控制终端既可以通过/dev/tty也可以通过该终端设备所对应的设备文件来访问。ttyname函数可以由文件描述符查出对应的文件名，该文件描述符必须指向一个终端设备而不能是任意文件。在linux上的命令tty 也可以查看到当前的终端。</p>
<p>比如我们在图形界面下打开一个终端可能是/dev/pts/0, 第二个可能是/dev/pts/1 .. (网络终端)，而切换到字符界面下可能是/dev/tty1 …(虚拟终端)</p>
<h4 id="3）进程和终端："><a href="#3）进程和终端：" class="headerlink" title="3）进程和终端："></a>3）进程和终端：</h4><p>用户通过终端登录系统后得到一个Shell进程，Shell分前后台来控制的不是进程而是作业（Job）或者进程组（Process Group）。一个前台作业可以由多个进程组成，一个后台作业也可以由多个进程组成，Shell可以同时运行一个前台作业和任意多个后台作业，这称为作业控制（JobControl）。<br>例如用以下命令启动5个进程（这个例子出自APUE）：<br>$ proc1 | proc2 &amp;</p>
<p>$ proc3 | proc4 | proc5</p>
<p>　　其中proc1和proc2属于同一个后台进程组，proc3、proc4、proc5属于同一个前台进程组，Shell进程本身属于一个单独的进程组。这些进程组的控制终端相同，它们属于同一个Session，一个Session与一个控制终端相关。当用户在控制终端输入特殊的控制键（例如Ctrl-C）时，内核会发送相应的信号（例如SIGINT）给前台进程组的所有进程。各进程、进程组、Session的关系如下图所示。</p>
<p><img src="https://s2.loli.net/2023/08/01/chS9O7J1UiLzYAN.jpg"></p>
<p>在上面的例子中，proc3、proc4、proc5被Shell放到同一个前台进程组，其中有一个进程是该进程组的Leader，Shell调用wait等待它们运行结束。一旦它们全部运行结束，Shell就调用tcsetpgrp函数将自己提到前台继续接受命令。但是注意，如果proc3、proc4、proc5中的某个进程又fork出子进程，子进程也属于同一进程组，但是Shell并不知道子进程的存在，也不会调用wait等待它结束。换句话说，proc3 | proc4 | proc5是Shell的作业，而这个子进程不是，这是作业和进程组在概念上的区别。一旦作业运行结束，Shell就把自己提到前台，如果原来的前台进程组还存在（如果这个子进程还没终止），则它自动变成后台进程，被init进程接管。</p>
<p>Linux的普通进程(守护进程除外)是终端的子进程，进程的存在要依赖终端为其提供空间包括标准输入、标准输出、标准出错。当打开终端的最初的进程（也就是SID进程）退出后，其子进程也会结束。</p>
<h4 id="4）终端登录和执行命令的过程："><a href="#4）终端登录和执行命令的过程：" class="headerlink" title="4）终端登录和执行命令的过程："></a>4）终端登录和执行命令的过程：</h4><p>现在我们从Session和进程组的角度重新来看登录和执行命令的过程。</p>
<p>getty或telnetd进程在打开终端设备之前调用setsid函 数创建一个新的Session，该进程称为SessionLeader，该进程的id也可以看作Session的id，然后该进程打开终端设备作为这个Session中所有进程的控制终端。在创建新Session的同时也创建了一个新的进程组，该进程是这个进程组的Process Group Leader，该进程的id也是进程组的id。</p>
<p>在登录过程中，getty或telnetd进程变成login，然后变成Shell，但仍然是同一个进程，仍然是Session Leader。</p>
<p>由 Shell进程fork出的子进程（比如说上例中的p3，p4，p5）本来具有和Shell相同的Session、进程组和控制 终端，但是Shell调用setpgid函数将作业中的某个子进程指定为一个新进程组的 Leader（比如说p3），然后调用setpgid将该作业中的其它子进程也转移到这个进程组中。如果这个进程组需要在前台运行，就调用tcsetpgrp函数将它设置为前台进程组，由于一个 Session只能有一个前台进程组，所以Shell所在的进程组就自动变成后台进程组。</p>
<p>原理的参考资料：<a target="_blank" rel="noopener" href="https://blog.csdn.net/aganlengzi/article/details/46671217">Click Here</a></p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案:"></a>解决方案:</h3><h4 id="nohup命令"><a href="#nohup命令" class="headerlink" title="nohup命令"></a>nohup命令</h4><p>linux下输入以下指令</p>
<p><code>nohup ./nps &amp;</code></p>
<p>注:Unix/Linux下一般比如想让某个程序在后台运行，很多都是使用 &amp; 在程序结尾来让程序自动运行。可能我们的程序只是普通程序而已（并不是守护进程），一般这种程序使用 &amp; 结尾，但是如果终端关闭，那么程序也会被关闭。</p>
<p>使用nohup命令可以在后台执行程序并且终端退出仍然运行.</p>
<p>当屏幕屏幕提示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">　　[~]$ appending output to nohup.out</span><br><span class="line">　　证明运行成功，同时把程序运行的输出信息放到当前目录的 nohup.out 文件中去。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>附：nohup命令参考<br>　　nohup 命令<br>　　用途：不挂断地运行命令。<br>　　语法：nohup Command [ Arg … ] [　&amp; ]<br>　　描述：nohup 命令运行由 Command 参数和任何相关的 Arg 参数指定的命令，忽略所有挂断（SIGHUP）信号。在注销后使用 nohup 命令运行后台中的程序。要运行后台中的 nohup 命令，添加 &amp; （表示“and”的符号）到命令的尾部。<br>无论是否将 nohup 命令的输出重定向到终端，输出都将附加到当前目录的 nohup.out 文件中。如果当前目录的 nohup.out 文件不可写，输出重定向到 $HOME/nohup.out 文件中。如果没有文件能创建或打开以用于追加，那么 Command 参数指定的命令不可调用。如果标准错误是一个终端，那么把指定的命令写给标准错误的所有输出作为标准输出重定向到相同的文件描述符。</p>
</blockquote>
<h4 id="screen命令"><a href="#screen命令" class="headerlink" title="screen命令"></a>screen命令</h4><p>简单来说，Screen是一个可以在多个进程之间多路复用一个物理终端的窗口管理器。Screen中有会话的概念，用户可以在一个screen会话中创建多个screen窗口，在每一个screen窗口中就像操作一个真实的telnet/SSH连接窗口那样。在screen中创建一个新的窗口有这样几种方式：<br>1．直接在命令行键入screen命令</p>
<p>Screen将创建一个执行shell的全屏窗口。你可以执行任意shell程序，就像在ssh窗口中那样。在该窗口中键入exit退出该窗口，如果这是该screen会话的唯一窗口，该screen会话退出，否则screen自动切换到前一个窗口。</p>
<p>2．Screen命令后跟你要执行的程序。</p>
<p>Screen创建一个执行命令的单窗口会话，退出同时也将退出该窗口/会话。</p>
<p>3．以上两种方式都创建新的screen会话。我们还可以在一个已有screen会话中创建新的窗口。在当前screen窗口中键入C-a c，即Ctrl键+a键，之后再按下c键，screen 在该会话内生成一个新的窗口并切换到该窗口。</p>
<p>screen还有更高级的功能。你可以不中断screen窗口中程序的运行而暂时断开（detach）screen会话，并在随后时间重新连接（attach）该会话，重新控制各窗口中运行的程序。</p>
<p>参考资料:<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_4f8ea2ef0100zosg.html">Click Here</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://langeheris.github.io">Lange Heris</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://langeheris.github.io/2020/03/28/Intranet-penetration/">http://langeheris.github.io/2020/03/28/Intranet-penetration/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://langeheris.github.io" target="_blank">Soul Stream</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%99%E7%A8%8B/">教程</a><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/">内网穿透</a><a class="post-meta__tags" href="/tags/NAT/">NAT</a><a class="post-meta__tags" href="/tags/NPS/">NPS</a></div><div class="post_share"><div class="social-share" data-image="https://pic1.zhimg.com/80/v2-801f11f4b2bf9a7061965ac94bc8c9bb_720w.jpeg" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/03/07/Hexo-Create/" title="Hexo搭建"><img class="cover" src="/img/default_cover_post.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-03-07</div><div class="title">Hexo搭建</div></div></a></div><div><a href="/2020/05/01/SSR-RE/" title="SSR 搭建与免流"><img class="cover" src="https://pic1.zhimg.com/80/v2-f1251b075bf212ce34c29010f30c1e37_720w.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-01</div><div class="title">SSR 搭建与免流</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%E2%80%94%E2%80%94%E5%85%B3%E4%BA%8E%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">1.</span> <span class="toc-text">前言——关于内网穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">什么是内网穿透？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8F%AF%E4%BB%A5%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">内网穿透可以干什么？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E2%80%94%E2%80%94NPS"><span class="toc-number">2.</span> <span class="toc-text">解决方案——NPS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NPS"><span class="toc-number">2.1.</span> <span class="toc-text">NPS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E7%82%B9%EF%BC%9A"><span class="toc-number">2.2.</span> <span class="toc-text">特点：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">安装流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%80%89%E8%B4%AD%E6%96%B9%E9%9D%A2%EF%BC%9A"><span class="toc-number">3.1.</span> <span class="toc-text">服务器选购方面：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">服务端配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">客户端配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E6%96%B0%E5%A2%9E%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.3.1.</span> <span class="toc-text">第一步 新增客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E5%A4%8D%E5%88%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8C%87%E4%BB%A4"><span class="toc-number">3.3.2.</span> <span class="toc-text">第二步 复制客户端指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E5%90%AF%E5%8A%A8%E5%AE%A2%E6%88%B7%E7%AB%AF-amp-RDP%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.3.3.</span> <span class="toc-text">第三步 启动客户端&amp;RDP协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%93%BE%E6%8E%A5-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-amp-%E9%85%8D%E7%BD%AEnps%E5%AE%A2%E6%88%B7%E7%AB%AFnpc-conf%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.4.</span> <span class="toc-text">客户端通过配置文件链接_报错解决方案 &amp; 配置nps客户端npc.conf文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">3.3.4.1.</span> <span class="toc-text">配置文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.4.1.1.</span> <span class="toc-text">全局配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E4%BB%A3%E7%90%86"><span class="toc-number">3.3.4.1.2.</span> <span class="toc-text">域名代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tcp%E9%9A%A7%E9%81%93%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.4.1.3.</span> <span class="toc-text">tcp隧道模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.4.1.4.</span> <span class="toc-text">http代理模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#socks5%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.4.1.5.</span> <span class="toc-text">socks5代理模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A7%81%E5%AF%86%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.4.1.6.</span> <span class="toc-text">私密代理模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#p2p%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.4.1.7.</span> <span class="toc-text">p2p代理模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.4.1.8.</span> <span class="toc-text">文件访问模式</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NPS%E7%8E%A9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">NPS玩法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP-UDP%E9%9A%A7%E9%81%93"><span class="toc-number">4.1.</span> <span class="toc-text">TCP&#x2F;UDP隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">配置方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#P2P%E8%BF%9E%E6%8E%A5"><span class="toc-number">4.2.</span> <span class="toc-text">P2P连接</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%96%91%E9%9A%BE%E8%A7%A3%E7%AD%94"><span class="toc-number">5.</span> <span class="toc-text">疑难解答</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-%E6%96%AD%E5%BC%80Linux%E8%BF%9C%E7%A8%8B%E7%BB%88%E7%AB%AF%E5%85%B3%E9%97%AD%E5%90%8E%EF%BC%8CNPS%E5%90%8E%E5%8F%B0%E7%9A%84%E8%BF%9B%E7%A8%8B%E4%B9%9F%E7%BB%93%E6%9D%9F%E4%BA%86%EF%BC%9F"><span class="toc-number">5.1.</span> <span class="toc-text">为什么 断开Linux远程终端关闭后，NPS后台的进程也结束了？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">5.1.1.</span> <span class="toc-text">原理：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">1）进程的相关概念：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E7%BB%88%E7%AB%AF%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">2）终端的相关概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BB%88%E7%AB%AF%EF%BC%9A"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">3）进程和终端：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E7%BB%88%E7%AB%AF%E7%99%BB%E5%BD%95%E5%92%8C%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">5.1.1.4.</span> <span class="toc-text">4）终端登录和执行命令的过程：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.1.2.</span> <span class="toc-text">解决方案:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nohup%E5%91%BD%E4%BB%A4"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">nohup命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#screen%E5%91%BD%E4%BB%A4"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">screen命令</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://pic4.zhimg.com/80/v2-21523755f9b6229453735a5aab21d370_720w.jpeg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Lange Heris</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" class="no-underline">本网站由 <img src="https://cdn.jsdelivr.net/gh/xingjiahui/CDN/又拍云_logo.png"align="absmiddle" width="59px" height="30px" /> 提供CDN加速/云存储服务</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'k8wl1SQ3KAzoDHfqRbgfOUX2-gzGzoHsz',
      appKey: 'IKiKisGyg2hHzwX42e0xRDRw',
      avatar: 'identicon',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><div class="aplayer no-destroy" data-id="4902786037" data-server="netease" data-type="playlist" data-order="list" data-mini="true" data-mutex="true" data-lrctype="false" data-fixed="true" data-autoplay="false" data-theme="#000000"> </div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/source/_posts/So-VITS.md"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'UA-160039268-1', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>